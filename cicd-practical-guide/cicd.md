##書籍
GitHub CI/CD実践ガイド――持続可能なソフトウェア開発を支えるGitHub Actionsの設計と運用 エンジニア選書

# 内容
## 2章

- github action のワークフローの実行履歴の確認
    - gh run watch ・・実行中のものを確認
    - gh run view ・・終了しているものを確認

- ワークフローは定期実行イベントも定義できる

- ジョブの実行環境について
    - githubの実行環境はGitHub-Hosted RunnersとSelf Hosted Runnersの2種類ある
    - 様々なソフトウェアが初めからインストールされているが、バージョンは固定できないので非互換性の変更でエラーになる可能性があることは認識しておく必要がある
    - 実行環境は終了後に破棄される。この特性エフェメラルと呼ぶ

- github marketeplace
    - marketplaceで色々なアクションを探すことができる

## 3章

- コンテキストと環境変数
    - **コンテキスト**は、ジョブの実行中に動的に評価されるオブジェクトで、さまざまな情報を提供します。`${{ }}`の形式で参照されます。
    - **デフォルト環境変数**は、ジョブの実行環境に静的に設定される変数で、直接変数名で参照されます。

- コンテキストを直接シェルコマンドへ埋め込むのはアンチパターン
    - コンテキストによっては特殊文字が含まれるためシェルコマンドに影響を与える可能性がある
    - 中間環境変数を利用することでこの問題は回避可能
    
- コンテキストと環境変数の使用時のルール
    1. コンテキストはシェルコマンドへハードコードせず、環境変数を経由して渡す
    2. 環境変数はすべてダブルクォーテーションで囲む
    
- ワークフローの名前
    - ワークフロー名、ジョブ名、ステップ名を設定することが可能

- ステップ間の変数共有
    - 環境変数はステップ間で引き継ぐことはできない
    - 以下の2つの方法でデータ共有が可能
        - GITHUB_OUTPUT環境変数を使用する
        - GITHUB_ENV環境変数を使用する
        
        ENVの方はグローバル変数になるので、基本的にはOUTPUTの方を使用するのが良い
        
        ```
        - id: <step-id>
          run: echo "<key>=<value>" >> "${GITHUB_OUTPUT}"
        ```

        ```
        ${{ steps.<step-id>.outputs.<key> }}
        ```
        
        
- GitHub Apiの使用
    - Apiを使用するにはGITHUB_TOKENの設定とその権限の制御が必要
        - TOKENはGAが自動的に作成してくれるのでそれを使用する
        - 権限はパーミションで必要な分だけ設定する
            - ソースコードの読み込みは暗黙的に許可されている(ただし、パーミションを明示的に設定した場合は無効化されるので注意)

## 4章

- フィルターを使用することでワークフローの起動条件を指定できる。複数指定するとAND条件になる
    - paths・・指定したファイルパスのみ
    - branches・・指定したブランチのみ
    - tags・・指定したGitタグのみ

- フィルターの記述はGlobを使用するこで柔軟なパターンに対応可能

- アクティビティタイプを使用するとイベントの種類に応じた制御が可能になる
    
    ```jsx
    on:
    	issues:
    		types: [opend, edited]
    ```
    
- プログラミング言語を使用する場合は言語のセットアップアクションが必要。セットアップアクションはキャッシュを有効化できる。そうすることで、他のワークフローから参照可能になる。

- 言語のバージョン指定にはバージョンファイルを使用することも可能

- タイムアウト
    - GAのワークフローのデフォルトタイムアウトは360分と長いので基本的にはつけるようにする

- シェル
    - GAでは複数のシェルをステップごとに切り替えることが可能
    - シェルを指定しなかった場合はデフォルト(mac、ubuntu)でBashが起動される。デフォルト起動の場合はパイプのエラーが無視されるのでエラーの発生箇所が分かりにくくなる。そのため、デフォルトシェルを明示的に指定するのがおすすめ
    
    ```jsx
    defaults:
      run:
        shell: bash
    ```
    
- Concurrency
    - GAはイベント駆動なので、イベントが発生した分だけワークフローが起動する
    - 多重起動を制御するためにはConcurrencyグループを定義する。グループを定義するとそのグループは複数起動することがなくなる
    
    ```jsx
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    ```
    
- CIのクリーンな状態に保つには
    - CIの実行時間を短くする
        - テストはユニットテストを中心にする
    - ノイズを減らす
        - ノイズとは何か事象が発生しても問題ないと切り捨ててしまうようなこと
        

## 5章

- デバッグログの設定方法
    - ワークフローの再実行時に「Enable debug logging」を有効化する
    - SecretsまたはVariablesへ特定の値をセットする

- Bashのトレーシングオプションを使用するのもあり(set -x コマンドで有効化)

- ジョブの並列実行
    - jobsに複数のジョブを定義するとそれらは並列に実行される
        - 複数定義したジョブを並列ではなく逐次実行したい場合はneedsを設定する
        - ジョブの終了時にoutputsキーを指定することで、次のジョブへデータを渡すこともできる

- キャッシュ
    - キャッシュの挙動を細かく設定したい場合はkey、path、restore-keysを指定して設定できる
        - restore-keys は keyに一致するキャッシュが存在しない場合に使用する。restore-keysのプレフィックスが一致するキャッシュを取得できる(パッケージマネージャーと併用することが多い)
    - キャッシュの削除
        - 7日以上アクセスされないものは自動削除
        - 合計サイズはリポジトリごとに10GB
    
- アーティファクトを使用すればワークロード内で生成したファイルを保存できる。ただしこれは永続的な保存ではないので注意。デフォルトでは90日間